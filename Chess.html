<!DOCTYPE html>
<html>

<head>
    <link rel="stylesheet" href="chess-styles.css">
    <script src="piece.js"></script>
    <script src="chessboard.js"></script>
    <!-- <script src="game.js" ></script> -->
</head>

<body onload="resetboard()">
    <table>
        <tr>
            <td bgcolor="grey" height="100%" width="25.75%">
                <table>
                    <tr height="50%">
                        <td id="B2play" class="black-turn">BLACK TO PLAY</td>
                    </tr>
                    <tr>
                        <td></td>
                    </tr>
                </table>
            </td>
            <td>
                <table id="table"></table>
            </td>
            <td height="100%" bgcolor="grey" width="25.75%">
                <table>
                    <tr height="50%">
                        <td id="W2play" class="white-turn">WHITE TO PLAY</td>
                    </tr>
                    <tr>
                        <td></td>
                    </tr>
                </table>
            </td>
        </tr>
    </table>
    <button onclick="resetboard()">start</button>
    <script>
        var enpassentPiece = null;

        validCells = [];

        var turn = "white";
        var action = "pick"
        var killables = [];
        var currentSelection = -1;


        // var game = new Game();
        // var chessboard = game.chessboard;

        var chessboard = resetChessBoard();



        let history = [];

        function cellClicked(cellId) {
            var row = Math.floor(cellId / 8);
            var col = cellId % 8;
            var selectedPiece = chessboard[row][col];


            var currentSelectionRow = Math.floor(currentSelection / 8);
            var currentSelectionCol = currentSelection % 8;

            if (turn == "white" && action == "pick") {
                if (selectedPiece.color == "White") {
                    currentSelection = cellId;
                    currentSelectionRow = Math.floor(currentSelection / 8);
                    currentSelectionCol = currentSelection % 8;
                    action = "place";
                    resetKillables();
                    resetValidCells();
                    validateCells(currentSelectionRow, currentSelectionCol)
                }
            }
            else if (turn == "white" && action == "place") {
                if (validateMove(currentSelectionRow, currentSelectionCol, row, col) == true) {

                    if (enpassentPiece != chessboard[currentSelectionRow][currentSelectionCol])
                        enpassentPiece = null;

                    chessboard[currentSelectionRow][currentSelectionCol].moves_done++;
                    chessboard[row][col] = chessboard[currentSelectionRow][currentSelectionCol];
                    chessboard[currentSelectionRow][currentSelectionCol] = nullPiece;
                    currentSelection = -1;
                    action = "pick";
                    turn = "black";
                    resetKillables();
                    resetValidCells();
                }
                else if (validateMove(currentSelectionRow, currentSelectionCol, row, col) == "queen_castle") {
                    enpassentPiece = null;
                    chessboard[currentSelectionRow][currentSelectionCol].moves_done++;
                    chessboard[row][col] = chessboard[currentSelectionRow][currentSelectionCol];
                    chessboard[currentSelectionRow][currentSelectionCol] = nullPiece;
                    chessboard[currentSelectionRow][currentSelectionCol - 1] = chessboard[currentSelectionRow][0];
                    chessboard[currentSelectionRow][0] = nullPiece;
                    currentSelection = -1;
                    action = "pick";
                    turn = "black";
                    resetKillables();
                    resetValidCells();
                }
                else if (validateMove(currentSelectionRow, currentSelectionCol, row, col) == "castle") {
                    enpassentPiece = null;
                    chessboard[currentSelectionRow][currentSelectionCol].moves_done++;
                    chessboard[row][col] = chessboard[currentSelectionRow][currentSelectionCol];
                    chessboard[currentSelectionRow][currentSelectionCol] = nullPiece;
                    chessboard[currentSelectionRow][currentSelectionCol + 1] = chessboard[currentSelectionRow][7];
                    chessboard[currentSelectionRow][7] = nullPiece;
                    currentSelection = -1;
                    action = "pick";
                    turn = "black";
                    resetKillables();
                    resetValidCells();
                }
                else if (validateMove(currentSelectionRow, currentSelectionCol, row, col) == "-1") {
                    enpassentPiece = null;
                    chessboard[currentSelectionRow][currentSelectionCol].moves_done++;
                    chessboard[row][col] = chessboard[currentSelectionRow][currentSelectionCol];
                    chessboard[currentSelectionRow][currentSelectionCol] = nullPiece;
                    chessboard[currentSelectionRow][currentSelectionCol - 1] = nullPiece;
                    currentSelection = -1;
                    action = "pick";
                    turn = "black";
                    resetKillables();
                    resetValidCells();
                }
                else if (validateMove(currentSelectionRow, currentSelectionCol, row, col) == "one") {
                    enpassentPiece = null;
                    chessboard[currentSelectionRow][currentSelectionCol].moves_done++;
                    chessboard[row][col] = chessboard[currentSelectionRow][currentSelectionCol];
                    chessboard[currentSelectionRow][currentSelectionCol] = nullPiece;
                    chessboard[currentSelectionRow][currentSelectionCol + 1] = nullPiece;
                    currentSelection = -1;
                    action = "pick";
                    turn = "black";
                    resetKillables();
                    resetValidCells();
                }


                if (selectedPiece.color == "White") {
                    currentSelection = cellId;
                    currentSelectionRow = Math.floor(currentSelection / 8);
                    currentSelectionCol = currentSelection % 8;
                    action = "place";
                    resetKillables();
                    resetValidCells();
                    validateCells(currentSelectionRow, currentSelectionCol);
                }
            }
            else if (turn == "black" && action == "pick") {
                if (selectedPiece.color == "Black") {
                    currentSelection = cellId;
                    currentSelectionRow = Math.floor(currentSelection / 8);
                    currentSelectionCol = currentSelection % 8;
                    action = "place";
                    resetKillables();
                    resetValidCells();
                    validateCells(currentSelectionRow, currentSelectionCol);
                }
            }
            else if (turn == "black" && action == "place") {

                if (selectedPiece == nullPiece || selectedPiece.color == "White") {
                    if (validateMove(currentSelectionRow, currentSelectionCol, row, col) == true) {

                        if (enpassentPiece != chessboard[currentSelectionRow][currentSelectionCol])
                            enpassentPiece = null;

                        chessboard[currentSelectionRow][currentSelectionCol].moves_done++;
                        chessboard[row][col] = chessboard[currentSelectionRow][currentSelectionCol];
                        chessboard[currentSelectionRow][currentSelectionCol] = nullPiece;
                        currentSelection = -1;
                        action = "pick";
                        turn = "white";
                        resetKillables();
                        resetValidCells();
                    }
                    else if (validateMove(currentSelectionRow, currentSelectionCol, row, col) == "queen_castle") {
                        enpassentPiece = null;
                        chessboard[currentSelectionRow][currentSelectionCol].moves_done++;
                        chessboard[row][col] = chessboard[currentSelectionRow][currentSelectionCol];
                        chessboard[currentSelectionRow][currentSelectionCol] = nullPiece;
                        chessboard[currentSelectionRow][currentSelectionCol - 1] = chessboard[currentSelectionRow][0];
                        chessboard[currentSelectionRow][0] = nullPiece;
                        currentSelection = -1;
                        action = "pick";
                        turn = "white";
                        resetKillables();
                        resetValidCells();
                    }
                    else if (validateMove(currentSelectionRow, currentSelectionCol, row, col) == "castle") {
                        enpassentPiece = null;
                        chessboard[currentSelectionRow][currentSelectionCol].moves_done++;
                        chessboard[row][col] = chessboard[currentSelectionRow][currentSelectionCol];
                        chessboard[currentSelectionRow][currentSelectionCol] = nullPiece;
                        chessboard[currentSelectionRow][currentSelectionCol + 1] = chessboard[currentSelectionRow][7];
                        chessboard[currentSelectionRow][7] = nullPiece;
                        currentSelection = -1;
                        action = "pick";
                        turn = "white";
                        resetKillables();
                        resetValidCells();
                    }
                    else if (validateMove(currentSelectionRow, currentSelectionCol, row, col) == "-1") {
                        enpassentPiece = null;
                        chessboard[currentSelectionRow][currentSelectionCol].moves_done++;
                        chessboard[row][col] = chessboard[currentSelectionRow][currentSelectionCol];
                        chessboard[currentSelectionRow][currentSelectionCol] = nullPiece;
                        chessboard[currentSelectionRow][currentSelectionCol - 1] = nullPiece;
                        currentSelection = -1;
                        action = "pick";
                        turn = "white";
                        resetKillables();
                        resetValidCells();
                    }
                    else if (validateMove(currentSelectionRow, currentSelectionCol, row, col) == "one") {
                        enpassentPiece = null;;
                        chessboard[currentSelectionRow][currentSelectionCol].moves_done++;
                        chessboard[row][col] = chessboard[currentSelectionRow][currentSelectionCol];
                        chessboard[currentSelectionRow][currentSelectionCol] = nullPiece;
                        chessboard[currentSelectionRow][currentSelectionCol + 1] = nullPiece;
                        currentSelection = -1;
                        action = "pick";
                        turn = "white";
                        resetKillables();
                        resetValidCells();
                    }
                }
                else if (selectedPiece.color == "Black") {
                    currentSelection = cellId;
                    action = "place";
                    currentSelectionRow = Math.floor(currentSelection / 8);
                    currentSelectionCol = currentSelection % 8;
                    resetKillables();
                    resetValidCells();
                    validateCells(currentSelectionRow, currentSelectionCol);
                }
            }


            drawboard(turn)
        }


        function drawboard(turn) {
            var blacklose = 0, whitelose = 0;
            document.getElementById("B2play").innerHTML = "";
            document.getElementById("W2play").innerHTML = "";
            if (turn == "white") {
                document.getElementById("W2play").innerHTML = "WHITE TO PLAY";
            }
            else {
                document.getElementById("B2play").innerHTML = "BLACK TO PLAY";
            }
            var table = document.getElementById("table");
            table.innerHTML = "";

            var currentcell = 0;
            for (var x = 0; x < 8; x++) {
                var row = table.insertRow(x);
                for (var y = 0; y < 8; y++) {
                    var cell = row.insertCell(y);
                    cell.setAttribute("id", currentcell);
                    cell.setAttribute('onclick', 'cellClicked(' + currentcell + ');');
                    cell.innerHTML = chessboard[x][y].displayText();

                    if (chessboard[x][y].color == "Black") {
                        cell.classList.add("black-piece");
                    }
                    else if (chessboard[x][y].color == "White") {
                        cell.classList.add("white-piece");
                    }

                    if ((x + y) % 2 == 0) {
                        cell.classList.add("white-square");
                    }
                    else {
                        cell.classList.add("black-square");
                    }
                    currentcell++;
                    validCells.forEach(element => {
                        if (element.x == x && element.y == y) {
                            cell.classList.add("valid");
                        }

                    });
                    killables.forEach(element => {
                        if (element.x == x && element.y == y) {
                            cell.classList.add("can-kill");
                        }

                    });


                }
            }

            if (currentSelection != -1) {
                document.getElementById(currentSelection).classList.add("selected-cell");

            }
        }
        function resetboard() {

            // resetGame();

            chessboard = resetChessBoard();

            let history = [];
            var action = "pick"
            var currentSelection = -1;

            drawboard("white")
        }

        function validateMove(cellrow, cellcol, destinationrow, destinationcol) {
            var cell = chessboard[cellrow][cellcol];
            // cell.enpassent = 0
            // enpassentPiece=null
            var destination = chessboard[destinationrow][destinationcol];
            var rowdiff = Math.abs(cellrow - destinationrow);
            var coldiff = Math.abs(cellcol - destinationcol);
            if (cell.color != destination.color) {
                if (cell.type == "Pawn") {
                    if (destination == nullPiece) {
                        if (cell.color == "White" && chessboard[cellrow - 1][cellcol] == nullPiece) {
                            if ((coldiff == 0 && (cellrow - 2 == destinationrow && cellrow == 6))) {
                                console.log("Setting enpassentPiece to ", cell);
                                enpassentPiece = cell;
                                return true;
                            }
                            else if (cellrow - 1 == destinationrow && coldiff == 0) {
                                return true;
                            }
                            else if (cellrow - 1 == destinationrow && coldiff == 1) {
                                if (cellcol > destinationcol) {
                                    if (chessboard[cellrow][cellcol - 1] == enpassentPiece) {
                                        killables.push({ x: destinationrow, y: destinationcol });
                                        return ("-1");
                                    }
                                }
                                else if (cellcol < destinationcol) {
                                    if (chessboard[cellrow][cellcol + 1] == enpassentPiece) {
                                        killables.push({ x: destinationrow, y: destinationcol });
                                        console.log(chessboard[cellrow][cellcol]);
                                        return ("one");
                                    }
                                }
                            }
                        }
                        else if (cell.color == "Black" && chessboard[cellrow + 1][cellcol] == nullPiece) {
                            if (coldiff == 0 && (cellrow + 2 == destinationrow && cellrow == 1)) {
                                console.log("Setting enpassentPiece to ", cell);
                                enpassentPiece = cell;
                                return true;
                            }
                            else if (coldiff == 0 && cellrow + 1 == destinationrow) {
                                return true;
                            }
                            else if (cellrow + 1 == destinationrow && coldiff == 1) {
                                if (cellcol > destinationcol) {
                                    if (chessboard[cellrow][cellcol - 1] == enpassentPiece) {
                                        killables.push({ x: destinationrow, y: destinationcol });
                                        return ("-1");
                                    }
                                }
                                else if (cellcol < destinationcol) {
                                    if (chessboard[cellrow][cellcol + 1] == enpassentPiece) {
                                        killables.push({ x: destinationrow, y: destinationcol });
                                        return ("one");
                                    }
                                }
                            }
                        }
                    }
                    else if (destination != nullPiece) {
                        if (cell.color == "White") {
                            if (cellrow - destinationrow == 1 && coldiff == 1 && destination.color == "Black") {
                                killables.push({ x: destinationrow, y: destinationcol });
                                return true;
                            }
                        }
                        if (cell.color == "Black") {
                            if (cellrow - destinationrow == -1 && coldiff == 1 && destination.color == "White") {
                                killables.push({ x: destinationrow, y: destinationcol });
                                return true;
                            }
                        }
                    }
                }
                else if (cell.type == "Rook") {
                    if (checkintermediates(cellrow, cellcol, destinationrow, destinationcol, "horizontal")) {
                        return true;
                    }
                }
                else if (cell.type == "Bishop") {
                    if (checkintermediates(cellrow, cellcol, destinationrow, destinationcol, "diagonal")) {
                        return true;
                    }
                }
                else if (cell.type == "Knight") {
                    if (coldiff == 2 && rowdiff == 1 || coldiff == 1 && rowdiff == 2) {
                        if (chessboard[destinationrow][destinationcol] != nullPiece) {
                            killables.push({ x: destinationrow, y: destinationcol });
                        }
                        return true;
                    }

                }
                else if (cell.type == "King") {
                    var coldifference = cellcol - destinationcol;
                    var rowdifference = cellrow - destinationrow;
                    if (coldiff < 2 && rowdiff < 2) {
                        if (chessboard[destinationrow][destinationcol] != nullPiece) {
                            killables.push({ x: destinationrow, y: destinationcol });
                        }
                        return true;
                    }
                    else if (coldiff == 2 && rowdiff == 0) {
                        if (CheckCastle(cellrow, cellcol, destinationrow, destinationcol, coldiff, rowdiff, coldifference, rowdifference, cell) == "queen_castle") {
                            return ("queen_castle");
                        }
                        else if (CheckCastle(cellrow, cellcol, destinationrow, destinationcol, coldiff, rowdiff, coldifference, rowdifference, cell) == "castle") {
                            return ("castle");
                        }
                    }
                }
                else if (cell.type == "Queen") {
                    if (coldiff == rowdiff) {
                        if (checkintermediates(cellrow, cellcol, destinationrow, destinationcol, "diagonal")) {
                            return true;
                        }
                    }
                    else if ((coldiff == 0 && rowdiff != 0) || (rowdiff == 0 && coldiff != 0)) {
                        if (checkintermediates(cellrow, cellcol, destinationrow, destinationcol, "horizontal")) {
                            return true;
                        }
                    }
                }
            }

            // return {
            //     isValid: true,
            //     isKilling: true,
            //     type: "castle"
            // };

        }
        function validateCells(cellrow, cellcol) {
            var x, y;
            console.log("cells validating with cell id as ", x, y)
            for (x = 0; x < 8; x++) {
                for (y = 0; y < 8; y++) {
                    if (validateMove(cellrow, cellcol, x, y)) {
                        // var cell = chessboard[x][y];
                        validCells.push({ x: x, y: y });
                    }
                }
            }

        }

        function resetValidCells() {
            validCells = [];
            // resetValidCells();
        }

        function checkintermediates(cellrow, cellcol, destinationrow, destinationcol, type) {
            var rowdifference = cellrow - destinationrow;
            var coldifference = cellcol - destinationcol;
            var coldiff = Math.abs(coldifference);
            var rowdiff = Math.abs(rowdifference);
            var coldir = coldifference / coldiff;
            var rowdir = rowdifference / rowdiff;

            if (type == "diagonal") {
                if (coldiff == rowdiff) {
                    for (var x = 1; x < coldiff; x++) {
                        if (chessboard[cellrow - rowdir * x][cellcol - coldir * x] != nullPiece) {
                            return false;
                        }
                    }
                    if (chessboard[destinationrow][destinationcol] != nullPiece) {
                        killables.push({ x: destinationrow, y: destinationcol });
                    }
                    return true;
                }
            }
            else if (type = "horizontal") {
                if (coldiff == 0) {
                    for (var y = 1; y < rowdiff; y++) {
                        if (chessboard[cellrow - y * rowdir][cellcol] != nullPiece) {
                            return false;
                        }
                    }
                    if (chessboard[destinationrow][destinationcol] != nullPiece) {
                        killables.push({ x: destinationrow, y: destinationcol });
                    }
                    return true;
                }
                else if (rowdiff == 0) {
                    for (var z = 1; z < coldiff; z++) {
                        if (chessboard[cellrow][cellcol - z * coldir] != nullPiece) {
                            return false;
                        }
                    }
                    if (chessboard[destinationrow][destinationcol] != nullPiece) {
                        killables.push({ x: destinationrow, y: destinationcol });
                    }
                    return true;
                }
                else {
                    return false;
                }
            }
        }
        function resetKillables() {
            killables = [];
            // resetKillables();
        }

        function CheckCastle(cellrow, cellcol, destinationrow, destinationcol, coldiff, rowdiff, coldifference, rowdifference, cell) {
            if (cellcol > destinationcol && chessboard[cellrow][0].moves_done == 0 && cell.moves_done == 0) {
                for (var count = 1; count < 4; count++) {
                    if (chessboard[cellrow][cellcol - count] != nullPiece) {
                        return (false);
                    }
                }
                return ("queen_castle");
            }
            if (cellcol < destinationcol && chessboard[cellrow][7].moves_done == 0 && cell.moves_done == 0) {
                for (var count = 1; count < 3; count++) {
                    if (chessboard[cellrow][cellcol + count] != nullPiece) {
                        return (false);
                    }
                }
                return ("castle");
            }
        }
        function resetpassent(row, col) {
            // for (var x = 0; x < 8; x++) {
            //     for (var y = 0; y < 8; y++) {
            //         if (x != row || y != col) {
            //             chessboard[x][y].enpassent = 0;
            //         }
            //     }
            // }
        }


    </script>
</body>